services:
  health_status_dashboard:
    container_name: health_status_dashboard

    build:
      context: .
      dockerfile: dockerfile

    restart: unless-stopped 
 
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock:ro"


    extra_hosts:
      - "host.docker.internal:host-gateway"
 


    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.health_status_dashboard.rule=Host(`status.huzaifairfan.com`)"

      - "traefik.http.routers.health_status_dashboard.entrypoints=websecure"
      - "traefik.http.routers.health_status_dashboard.tls=true"
      - "traefik.http.routers.health_status_dashboard.tls.certresolver=le"
      
      # - "traefik.http.services.health_status_dashboard.loadbalancer.server.port=3000"
      # - "traefik.http.services.health_status_dashboard.loadbalancer.server.scheme=http"

      - "traefik.http.services.health_status_dashboard.loadbalancer.server.url=http://health_status_dashboard:8000"
     
    networks:
      - web
      - health_status_dashboard

    depends_on:
      - redis


  worker:
    build: .
    container_name: celery-worker
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    command: uv run celery -A celery_worker worker --loglevel=info
    depends_on:
      - redis
    networks:
      - health_status_dashboard

  beat:
    build: .
    container_name: celery-beat
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - redis
    command: uv run celery -A celery_worker beat --loglevel=info
    environment:
      - CELERY_ENABLE_UTC=true
    networks:
      - health_status_dashboard
  redis:
    image: redis:7-alpine
    container_name: redis-broker
    networks:
      - health_status_dashboard

networks:
  health_status_dashboard:
    driver: bridge
  web:
    external: true